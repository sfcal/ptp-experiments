---
- name: Install requirements
  ansible.builtin.package:
    name: "{{ kernel_requirements }}"
    state: present

- name: Download kernel archive
  ansible.builtin.unarchive:
    src: "{{ kernel_unarchive_src }}"
    dest: "{{ kernel_build_location }}"
    remote_src: true
    creates: "{{ kernel_unarchive_creates }}"
    mode: "0755"

- name: Copy running kernel config
  ansible.builtin.copy:
    src: /boot/config-{{ ansible_kernel }}
    dest: "{{ kernel_build_location }}/linux-{{ kernel_version }}/.config"
    remote_src: yes
    mode: "0640"

- name: Copy patches to kernel source
  ansible.builtin.copy:
    src: "patches/{{ item }}"
    dest: "{{ kernel_build_location }}/linux-{{ kernel_version }}/{{ item }}"
    mode: "0644"
  loop: "{{ kernel_patches }}"
  when: kernel_patches is defined

- name: Apply kernel patches
  ansible.builtin.command:
    cmd: "patch -p1 < {{ item }}"
    chdir: "{{ kernel_build_location }}/linux-{{ kernel_version }}"
  loop: "{{ kernel_patches }}"
  when: kernel_patches is defined
  register: patch_result
  failed_when: 
    - patch_result.rc != 0
    - "'patch detected!  Skipping patch' not in patch_result.stdout"
  changed_when: "'patching file' in patch_result.stdout"
  
- name: Update config to new kernel version
  ansible.builtin.command:
    cmd: make olddefconfig
    chdir: "{{ kernel_build_location }}/linux-{{ kernel_version }}"

- name: Change selected parameters in config
  ansible.builtin.command:
    cmd: "./scripts/config --set-val {{ item.name }} {{ item.value }}"
    chdir: "{{ kernel_build_location }}/linux-{{ kernel_version }}"
  loop: "{{ kernel_parameters }}"
  when:
    - kernel_parameters is defined

- name: Resolve config dependencies after changes
  ansible.builtin.command:
    cmd: make olddefconfig
    chdir: "{{ kernel_build_location }}/linux-{{ kernel_version }}"

- name: Make
  ansible.builtin.command:
    cmd: make -j {{ ansible_processor_vcpus * 2 }}
    chdir: "{{ kernel_build_location }}/linux-{{ kernel_version }}"
    creates: "{{ kernel_build_location }}/linux-{{ kernel_version }}/vmlinux"
  async: 7200
  poll: 0
  register: kernel_make

- name: Wait for make
  ansible.builtin.async_status:
    jid: "{{ kernel_make.ansible_job_id }}"
  register: kernel_wait_for_make
  until:
    - kernel_wait_for_make.finished
  retries: 240
  delay: 30

- name: Make modules_install
  ansible.builtin.command:
    cmd: make modules_install
    chdir: "{{ kernel_build_location }}/linux-{{ kernel_version }}"
    creates: "{{ kernel_modules_location }}"

- name: Ensure kernel directory exists
  ansible.builtin.file:
    path: "{{ kernel_installation_location | dirname }}"
    state: directory
    mode: "0750"

- name: Make install
  ansible.builtin.command:
    cmd: make install
    chdir: "{{ kernel_build_location }}/linux-{{ kernel_version }}"
    creates: "{{ kernel_installation_location }}"

- name: Generate or update initramfs
  ansible.builtin.command:
    cmd: "update-initramfs -u -k {{ kernel_version }}"
  failed_when: false
  register: initramfs_update

- name: Create initramfs if update failed
  ansible.builtin.command:
    cmd: "update-initramfs -c -k {{ kernel_version }}"
  when: initramfs_update.rc != 0

- name: Update GRUB
  ansible.builtin.command:
    cmd: update-grub
  changed_when: true